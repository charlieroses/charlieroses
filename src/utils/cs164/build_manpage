#!/bin/bash

MAN_SRC="$1"
TEST="$2"
DEST="${MAN_SRC%man}html"
DEST="${DEST#src/}"
SECTIONS_FILE="src/cs164/sections.tsv"


INFO="$(head -n 1 "${MAN_SRC}")"
NAME="$(echo "${INFO}" | cut -d' ' -f2 )"
SECTION="$(echo "${INFO}" | cut -d' ' -f3 )"
DATE="$(echo "${INFO}" | cut -d' ' -f4 )"
SOURCE="$(echo "${INFO}" | cut -d'"' -f2 )"
MANUAL="$(echo "${INFO}" | cut -d'"' -f4 )"

SIDEBAR="$(awk -f src/utils/cs164/generate_sidebar.awk "${SECTIONS_FILE}")"

HTML="$(groff -mandoc -Thtml "${MAN_SRC}")"
HTML="${HTML##*<h2>NAME}"
HTML="${HTML%%</body>*}"
HTML="$(echo "${HTML}" | sed 's/\\n/\&bsol;n/g' )"
HTML="$(echo "${HTML}" | sed "s/<h2>/<p class=\"h2\">/" | sed "s/<\/h2>/<\/p>/" )"
HTML="$(echo "${HTML}" | sed "s/width=\"3%\"/style=\"width: 3ch\"/" )"
HTML="$(echo "${HTML}" | sed "s/width=\"8%\"/style=\"width: 4ch\"/" )"
HTML="$(echo "${HTML}" | sed "s/width=\"11%\"/style=\"width: 7ch\"/" )"
HTML="$(echo "${HTML}" | sed "s/width=\"78%\"//" )"
HTML="$(echo "${HTML}" | sed "s/width=\"100%\"//" )"
HTML="$(echo "${HTML}" | sed "s/11%/7ch/" )"
HTML="$(echo "${HTML}" | sed "s/22%/14ch/" )"
HTML="$(echo "${HTML}" | sed "s/33%/21ch/" )"
HTML="$(echo "${HTML}" | sed "s/\(<pre style=\"\)/\1font-size:18px;/")"

NEWHEAD="<!DOCTYPE html>\n<html>\n<head>\n"
NEWHEAD="${NEWHEAD}\t<title>Introduction to Computer Science</title>\n"
if [[ -z "${TEST}" ]]
then
	NEWHEAD="${NEWHEAD}\t<base href=\"/cs164/\">\n"
else
	NEWHEAD="${NEWHEAD}\t<base href=\"$(pwd)/cs164/\">\n"
fi
NEWHEAD="${NEWHEAD}\t<link rel=\"stylesheet\" href=\"structure.css\">\n"
NEWHEAD="${NEWHEAD}\t<link rel=\"stylesheet\" href=\"styles.css\">\n"
NEWHEAD="${NEWHEAD}\t<link rel=\"stylesheet\" href=\"languages/man.css\">\n"
NEWHEAD="${NEWHEAD}</head>\n<body>\n"
NEWHEAD="${NEWHEAD}${SIDEBAR}\n"
NEWHEAD="${NEWHEAD}<div id=\"main\">\n"
NEWHEAD="${NEWHEAD}\t<div class=\"navigation\" id=\"top\">\n"
NEWHEAD="${NEWHEAD}\t\t<div class=\"left\">\n"
NEWHEAD="${NEWHEAD}\t\t\t${NAME}(${SECTION})\n"
NEWHEAD="${NEWHEAD}\t\t</div>\n"
NEWHEAD="${NEWHEAD}\t\t<div class=\"middle\">\n"
NEWHEAD="${NEWHEAD}\t\t\t${MANUAL}\n"
NEWHEAD="${NEWHEAD}\t\t</div>\n"
NEWHEAD="${NEWHEAD}\t\t<div class=\"right\">\n"
NEWHEAD="${NEWHEAD}\t\t\t${NAME}(${SECTION})\n"
NEWHEAD="${NEWHEAD}\t\t</div>\n"
NEWHEAD="${NEWHEAD}\t</div><br>\n"
NEWHEAD="${NEWHEAD}<p class=\"h2\">NAME\n"

NEWTAIL=""
NEWTAIL="${NEWTAIL}\t<div class=\"navigation\" id=\"bottom\">\n"
NEWTAIL="${NEWTAIL}\t\t<div class=\"left\">\n"
NEWTAIL="${NEWTAIL}\t\t\t${SOURCE}\n"
NEWTAIL="${NEWTAIL}\t\t</div>\n"
NEWTAIL="${NEWTAIL}\t\t<div class=\"middle\">\n"
NEWTAIL="${NEWTAIL}\t\t\t${DATE}\n"
NEWTAIL="${NEWTAIL}\t\t</div>\n"
NEWTAIL="${NEWTAIL}\t\t<div class=\"right\">\n"
NEWTAIL="${NEWTAIL}\t\t\t${NAME}(${SECTION})\n"
NEWTAIL="${NEWTAIL}\t</div>\n"
NEWTAIL="${NEWTAIL}</div>\n</body>\n</html>\n"

echo "Building ${DEST}"
echo -e "${NEWHEAD}${HTML}${NEWTAIL}" > "${DEST}"
